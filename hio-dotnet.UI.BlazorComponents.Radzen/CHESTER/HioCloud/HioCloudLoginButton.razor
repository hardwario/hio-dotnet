@using Services
@using Microsoft.JSInterop

@inject DialogService DialogService
@inject HioCloudService HioCloudService
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime

@if (!HioCloudService.IsLoggedIn)
{
    <RadzenButton Text="Login" Disabled="@Disabled" Click="Login" Style="@Style" class="@Class" ButtonStyle="@ButtonStyle" />
}
else
{
    <RadzenButton Text="Login" Disabled Style="@Style" class="@Class" ButtonStyle="@ButtonStyle" />
}

@code {
    [Parameter] public string Style { get; set; } = string.Empty;
    [Parameter] public string Class { get; set; } = string.Empty;
    [Parameter] public ButtonStyle ButtonStyle { get; set; } = ButtonStyle.Primary;
    [Parameter] public bool Disabled { get; set; } = false;

    private string login = string.Empty;

    private string password = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            HioCloudService.OnLoggedIn += (s, e) =>
            {
                InvokeAsync(StateHasChanged);
            };
        }
    }

    private async Task Login()
    {
        var result = await DialogService.OpenAsync("Login To Cloud", ds =>
    @<RadzenStack Gap="1.5rem">
        <RadzenStack Orientation="Orientation.Vertical">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenLabel Text="Login:" Component="loginInput" />
                <RadzenTextBox Name="loginInput" @bind-Value="@login" Style="width: 100%;" />
             </RadzenStack>
             <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenLabel Text="Password:" Component="passwordinput" />
                <RadzenPassword @bind-Value="@password" Name="passwordinput" Style="width: 100%;" onkeydown="@(async (KeyboardEventArgs e) => OnKeyDown(e, ds))" />
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenButton Text="Login" Click="() => ds.Close(true)" />
                <RadzenButton Text="Cancel" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" />
            </RadzenStack>
        </RadzenStack>
    </RadzenStack>
    );

        if (result == true)
        {
            
            HioCloudService.InitHioCloudDriver(login, password);
            await Task.Delay(1000);

            if (!HioCloudService.IsLoggedIn)
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Login failed", Detail = "Cannot login to the cloud.", Duration = 4000 });
            }
            else
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Login Successfull", Detail = "Logged to the Hardwario Cloud.", Duration = 4000 });
            }
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e, DialogService ds)
    {
        if (e.Key == "Enter")
        {
            await JSRuntime.InvokeVoidAsync("document.activeElement.blur");
            ds.Close(true);
        }
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }
}
